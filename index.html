import matplotlib.pyplot as plt
import seaborn as sns
import plotly.graph_objects as go
import pandas as pd
import numpy as np
import base64
from io import BytesIO

# User Data
user_data = {
    'Age': 52,
    'Blood Pressure': 145,
    'Glucose': 160,
    'Albumin': 3,
    'Hemoglobin': 10.5,
    'Diabetes Mellitus': 'yes',
    'Hypertension': 'yes',
    'Smoking': 'yes',
    'Obesity': 'no',
    'Risk Score': 76,
    'CKD Risk Probability (5 Year)': 0.82
}

# Save matplotlib fig as base64 string
def fig_to_base64(fig):
    buf = BytesIO()
    fig.savefig(buf, format="png", bbox_inches="tight", dpi=100)
    buf.seek(0)
    img_bytes = buf.read()
    base64_str = base64.b64encode(img_bytes).decode('utf-8')
    plt.close(fig)
    return base64_str

# 1. Kidney Diagram
def draw_kidney():
    fig, ax = plt.subplots(figsize=(6, 6))
    kidney = plt.Circle((0.5, 0.5), 0.4, color='#ff9999', ec='#8b0000', lw=3)
    ax.add_patch(kidney)
    
    # Add renal components
    ax.plot([0.3, 0.5], [0.8, 0.5], color='#ff4444', lw=3, label='Renal Artery')
    ax.plot([0.7, 0.5], [0.8, 0.5], color='#4444ff', lw=3, label='Renal Vein')
    ax.plot([0.5, 0.5], [0.1, 0.3], color='#333333', lw=3, label='Ureter')
    
    ax.set_xlim(0, 1)
    ax.set_ylim(0, 1)
    ax.axis('off')
    ax.set_title('Kidney Anatomy Diagram', fontsize=14, pad=20)
    ax.legend(loc='upper center', bbox_to_anchor=(0.5, -0.05))
    return fig_to_base64(fig)

# 2. Bar Chart
def bar_chart_risk():
    risk_factors = {
        'Blood Pressure': user_data['Blood Pressure'],
        'Glucose': user_data['Glucose'],
        'Albumin': user_data['Albumin'],
        'Hemoglobin': user_data['Hemoglobin']
    }
    
    df = pd.DataFrame(list(risk_factors.items()), columns=['Parameter', 'Value'])
    fig, ax = plt.subplots(figsize=(8, 4))
    sns.barplot(x='Value', y='Parameter', data=df, palette='viridis', ax=ax)
    
    ax.set_title('Key Health Parameters', pad=15)
    ax.set_xlabel('Measurement Value', labelpad=10)
    ax.set_ylabel('')
    ax.grid(axis='x', linestyle='--', alpha=0.7)
    
    return fig_to_base64(fig), risk_factors

# 3. Pie Chart
def pie_chart_risk(risk_factors):
    labels = list(risk_factors.keys())
    sizes = list(risk_factors.values())
    
    fig, ax = plt.subplots(figsize=(6, 6))
    wedges, texts, autotexts = ax.pie(sizes, labels=labels, 
                                    autopct='%1.1f%%', startangle=140,
                                    colors=['#ff9999','#66b3ff','#99ff99','#ffcc99'])
    
    plt.setp(autotexts, size=10, weight="bold")
    ax.set_title('Parameter Value Distribution', pad=20)
    return fig_to_base64(fig)

# 4. Line Chart
def line_chart_risk():
    parameters = ['Blood Pressure', 'Glucose', 'Albumin', 'Hemoglobin']
    values = [user_data[p] for p in parameters]
    
    fig, ax = plt.subplots(figsize=(8, 4))
    ax.plot(parameters, values, marker='o', linestyle='-', color='#2ecc71', linewidth=2.5)
    
    ax.set_title('Parameter Value Trends', pad=15)
    ax.set_xlabel('Health Parameter', labelpad=10)
    ax.set_ylabel('Measurement Value', labelpad=10)
    ax.grid(True, linestyle='--', alpha=0.7)
    
    return fig_to_base64(fig)

# 5. Plotly Donut Chart
def plotly_donut_chart():
    probability = user_data['CKD Risk Probability (5 Year)']
    fig = go.Figure(data=[go.Pie(
        labels=['High Risk', 'Low Risk'],
        values=[probability, 1 - probability],
        hole=0.6,
        marker=dict(colors=['#e74c3c', '#2ecc71']),
        hoverinfo='label+percent',
        textinfo='percent'
    )])
    
    fig.update_layout(
        title_text='5-Year CKD Risk Probability',
        title_x=0.5,
        annotations=[dict(text=f'{probability*100:.0f}%', x=0.5, y=0.5, font_size=24, showarrow=False)]
    )
    return fig.to_html(full_html=False, include_plotlyjs='cdn')

# Create and Save HTML
def generate_html_report():
    kidney_img = draw_kidney()
    bar_img, risk_factors = bar_chart_risk()
    pie_img = pie_chart_risk(risk_factors)
    line_img = line_chart_risk()
    donut_html = plotly_donut_chart()

    html = f"""
<html>
<head>
    <title>CKD Risk Visualization Report</title>
    <style>
        body {{ 
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 2rem;
            background-color: #f5f6fa;
        }}
        .container {{ 
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
        }}
        h1 {{ 
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }}
        .chart-container {{ 
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }}
        img {{ 
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>CKD Risk Visualization Dashboard</h1>
        
        <div class="chart-container">
            <h2>Kidney Anatomy</h2>
            <img src="data:image/png;base64,{kidney_img}">
        </div>

        <div class="chart-container">
            <h2>Health Parameters</h2>
            <img src="data:image/png;base64,{bar_img}">
        </div>

        <div class="chart-container">
            <h2>Parameter Distribution</h2>
            <img src="data:image/png;base64,{pie_img}">
        </div>

        <div class="chart-container">
            <h2>Parameter Trends</h2>
            <img src="data:image/png;base64,{line_img}">
        </div>

        <div class="chart-container">
            <h2>5-Year Risk Probability</h2>
            {donut_html}
        </div>
    </div>
</body>
</html>
"""

    with open("ckd_report.html", "w") as f:
        f.write(html)
    print("âœ… Successfully generated CKD Report: 'ckd_report.html'")

# Execute the report generation
generate_html_report()
